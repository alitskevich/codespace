<component id="Page.Irregular">
  <IndexedDbService Ref="irrDb" (...)="{R.irrDb}" />
  <IndexedDbQuery Ref="query" db="<-irrDb" store="items" index="level" value="{level=='all'?'':level}*" />

  <Connector data="<- localStorage.irregularVerbsMode" change="-> quizMode = it ?? false" />
  <Connector data="<- localStorage.irregularVerbsLevel" change="-> level = it ?? 'all'" />
  <Connector data="<- localStorage.language" change="-> language = it ?? 'en'" />
  <Connector data="{data|calcIrregularVerbQuizProgress['percent']}" change="-> percent" />

  <Connector data="<-query.data" change="-> data" />


  <div class="fixed inset-0 pt-20">
    <Container class="flex flex-col items-stretch gap-4 h-full">
      <div class=" flex-auto flex flex-col min-h-0 md:m-4">
        <Fragment If="percent==100">
          <div class="flex flex-col gap-4">
            <div class="text-3xl text-center">🎉 Done! 🎉</div>
          </div>
          <Else>
            <IrregularVerbTable data="{data}" language="{language}" mode="{quizMode ? 'quiz' : 'table'}"
              columns="{quizMode ? R.columns.irregularQuiz : R.columns.irregular}" />
          </Else>
        </Fragment>
      </div>
    </Container>
  </div>

  <Header>
    <TopListSelector data="{R.enums.levels4}" change="-> localStorage.irregularVerbsLevel = it.value" value="{level}" />
    <Fragment If="percent==100">
      <Else>
        <Btn title="{quizMode ? R.strings.stop : R.strings.quiz} ({percent}%)"
          class="{quizMode ? '!text-white !bg-red-700' : ''}" action="-> localStorage.irregularVerbsMode = !quizMode" />
      </Else>
    </Fragment>
  </Header>

  <Settings If="<- localStorage.settings">
    <Btn title="{R.strings.reset} {R.strings.quiz}" class="!bg-orange-700 !text-white"
      action="-> irrDb.deleteDatabase(true)" />
  </Settings>
</component>

<component id="IrregularVerbTable">
  <AsyncLoader isLoading="{data|not}" title="Wait..." subtitle="🚀  Loading data" error="<- db.error"
    onError="-> db.downstream()">
    <Fragment If="!data.length">
      <Stub title="No data" />
      <Else>
        <Table class="" noHeader="true" groupCaptionType="IrregularVerbTableGroupCaption"
          data="{data| adaptIrregularVerbItems : language : mode| arraySortBy:'name'| arrayGroupBy:'id'}"
          columns="{columns}" cellChange="-> irrDb.upsertLocally()" sortBy="{sortBy}">
        </Table>
      </Else>
    </Fragment>
  </AsyncLoader>
</component>

<component id="IrregularVerb">
  <div class="relative inline-block cursor-pointer" click="-> out = value | speak">
    <span data="{data}" class="border-dotted border hover:border-gray-500 p-1 m-1
      text-nowrap leading-8 rounded-md  
      {correct ? 'text-white bg-green-800' :'bg-neutral-200 text-black'}">
      <span>{value}</span>
    </span>
    <!-- <Tooltip data="{data}" If="expanded" close="-> expanded=false" /> -->
  </div>
</component>

<component id="QuizOptionsSelector">
  <div class="inline-block">
    <div class="flex flex-no-wrap items-center gap-0 mx-1    
      divide-x divide-gray-400 text-sm
      cursor-pointer" role="group">
      <div Each="option of options" class="px-1 py-1 border border-gray-400
    first:rounded-l-lg last:rounded-r-lg  
    {option.id == value ? ' bg-red-600 text-white' : ' bg-neutral-200 text-gray-700' } 
    " data-value="{option.id}" click="{change}">
        <span class="">{option.name}</span>
      </div>
    </div>
  </div>
</component>

<component id="IrregularVerbQuiz">
  <Connector data="{_|assignKeyValue:mode:newValue}" data-id="{data.id}" data-store="items" change="{change}"
    trigger="{delayedNewValue}" />
  <Connector data="{data.f1},{data.f2},{data.f3},{data.f1}en,{data.f1}ed"
    change="-> options| split:','| arrayShuffle | arrayDedup | arrayJoin:','" />
  <Fragment If="newValue ?? answer == value">
    <Connector data="{newValue}" trigger="{newValue}" change="-> outloud | speak" />
    <IrregularVerb value="{value}" data="{data}" correct="true" />
    <audio src="{R.assets.tap}?code={newValue}" autoplay once If="newValue" />
    <Connector data="{newValue | delayedValue:1000}" change="-> delayedNewValue" />
    <Else>
      <QuizOptionsSelector options="{options}" change="-> newValue = it.value" value="{newValue ?? answer}" />
    </Else>
  </Fragment>
</component>

<component id="IrregularVerbTableGroupCaption">
  <div dir="{data.language != 'ar' ? 'ltr' : 'rtl'}" class="font-bold uppercase">{data.items.0.name}</div>
</component>

<component id="TableCell.IrregularVerbQuiz">
  <div class="inline-block p-2 grid grid-cols-1 gap-2 auto-cols-auto" style="grid-template-columns: 1fr;">
    <div>
      <span>{data.s1|strHead:data.f1}</span>
      <IrregularVerbQuiz value="{data.f1}" answer="{data.a1}" data="{data}" mode="a1" change="{change}" />
      <span>{data.s1|strTail:data.f1}</span>
    </div>
    <div>
      <span>{data.s2|strHead:data.f2}</span>
      <IrregularVerbQuiz value="{data.f2}" answer="{data.a2}" data="{data}" mode="a2" change="{change}" />
      <span>{data.s2|strTail:data.f2}</span>
    </div>
    <div>
      <span>{data.s3|strHead:data.f3}</span>
      <IrregularVerbQuiz value="{data.f3}" answer="{data.a3}" data="{data}" mode="a3" change="{change}" />
      <span>{data.s3|strTail:data.f3}</span>
    </div>
  </div>
</component>

<component id="TableCell.IrregularVerbExample">

  <div class="inline-block p-2 grid grid-cols-1 gap-2 auto-cols-auto" style="grid-template-columns: 1fr;">
    <div>
      <span>{data.s1|strHead:data.f1}</span>
      <IrregularVerb value="{data.f1}" data="{data}" correct="{data.f1 == data.a1}" />
      <span>{data.s1|strTail:data.f1}</span>
    </div>
    <div>
      <span>{data.s2|strHead:data.f2}</span>
      <IrregularVerb value="{data.f2}" data="{data}" correct="{data.f2 == data.a2}" />
      <span>{data.s2|strTail:data.f2}</span>
    </div>
    <div>
      <span>{data.s3|strHead:data.f3}</span>
      <IrregularVerb value="{data.f3}" data="{data}" correct="{data.f3 == data.a3}" />
      <span>{data.s3|strTail:data.f3}</span>
    </div>
  </div>
</component>